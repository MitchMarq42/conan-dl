#!/bin/sh

# I've just rewrote conan-dl
# Now in more POSIX-ish shell!
# And though it's still cringe
# We all love to binge
# So I'll fix it for good, what the hell?

. "${XDG_CONFIG_HOME:-$HOME/.config}/conan-dl/conan-dl.conf"

while getopts ":a:f:l:r:h" opt;
do
    case $opt in
        a)    anime=$OPTARG ;;
        f)    firstep=$OPTARG ;;
        l)    lastep=$OPTARG ;;
        r)    resolution=$OPTARG ;;

        h)
            echo "Conan-dl. Use at thy peril.
                  Options are as follows:
                  -a    anime
                  -f    firstep
                  -l    lastep
                  -r    resolution
                  -h    show this help"
            ;;
    esac
done

echo "Anime: $anime"
echo "Episodes: $firstep to $lastep"
echo "Resolution: $resolution"

search_anime () {
    # get proper anime name along with its id
    search=$(printf '%s' "$1" | tr ' ' '-' )
    titlepattern='<a href="/category/'

    curl -s "https://gogoanime.pe//search.html" \
        -G \
        -d "keyword=$search" |
    sed -n -E '
        s_^[[:space:]]*<a href="/category/([^"]*)" title="([^"]*)".*_\1_p
        '
}

animegg=$(
search_anime "$anime" |
    fzf
)

echo $animegg

get_embedurl() {
    animegg=$1
    epnum=$2
    curl -s "https://gogoanime.vc/$animegg-episode-$epnum" |
    sed -n -E '
        /^[[:space:]]*<a href="#" rel="100"/{
        s/.*data-video="([^"]*)".*/https:\1/p
        q
        }'
}
get_streamurl() {
    embedurl="$1"
    streamurl=$(curl -s "$embedurl" |
    sed -n -E '
        /^[[:space:]]*sources:/{
        s/.*(https[^'\'']*).*/\1/p
        q
        }
        ')
    printf '%s' "$streamurl" | sed -n -E "s/(.*)\.m3u8/\1.$resolution.m3u8/p"
}

eps=$(seq $firstep $lastep 2>/dev/null || cat ${XDG_CONFIG_HOME:-$HOME/.config}/conan-dl/eplist.list)

for epnum in $eps
do
    embedurl=$(get_embedurl "$animegg" "$epnum")
    streamurl=$(get_streamurl "$embedurl")
    # echo $embedurl
    # echo $streamurl
    (youtube-dl \
        "--add-header=Referer: $embedurl" \
        "$streamurl" -q && \
        echo "finished downloading episode $epnum") &
    echo "downloading episode $epnum"
done

wait && echo "all done!"
